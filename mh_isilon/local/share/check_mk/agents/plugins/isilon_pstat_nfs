#
# runtime can be between some msecs and up to half a minute
# so run this cached (due to sudden isi statistics failures)
# every 60sec seems to be too hard for Isilon
# I'll advice checking every 5 mins, so adjust this to 300sec
# adjust this to your service check interval for this device
#

SEP="<<<isilon_pstat_nfs>>>"
CLUSTER=$(hostname -s | sed 's/-[0-9][0-9]*$//')
TMPFILE=/ifs/home/check_mk/var/isilon_pstat_nfs.out

#
# isi suddenly fails, so try three times before giving up
#
for ((i=1; i<=3; i++))
do

  OUT=$(isi statistics pstat --protocol nfs3 --format csv 2>/dev/null | tail -1 | tr "," " ")

  if [ "x$OUT" == x ]
  then
     #
     # sleep up to 9sec
     #
     sleep $(echo ${RANDOM: -1})

  else
     #
     # output
     #
     echo $SEP
     echo $CLUSTER" $OUT"

     #
     # Spare in der Zeit, dann hast Du in der Not.
     #
     echo "$OUT" >${TMPFILE}

     exit 0
  fi
done

#
# getting here means we did not get isi statistics
# just return old data (i hope no one notices) or die quietly
#
if [ -e ${TMPFILE} 2>/dev/null ]
then
  OUT=$(cat ${TMPFILE})
  echo $CLUSTER" $OUT"
fi

